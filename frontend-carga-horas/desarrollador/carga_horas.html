<!DOCTYPE html>
<html lang="es">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="utf-8" />
  <title>Sistema de Gesti√≥n de Horas - Cargar Horas</title>
  <link rel="stylesheet" href="carga_horas.css" />
  <script src="../config.js"></script>
  <script src="../auth-service.js"></script>
  <script src="../route-guard.js"></script>
  <script src="../APIClient.js"></script>
</head>
<body>
<main class="cargar-horas">
  <!-- HEADER PRINCIPAL -->
  <nav class="rectangle-2" role="navigation">
    <h1 class="p">SISTEMA DE GESTI√ìN DE HORAS</h1>
    <div class="user-info">
      <span class="text-wrapper-5" id="userName">Cargando...</span>
      <div class="user" aria-label="Icono de usuario">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
      </div>
    </div>
  </nav>

  <!-- HEADER DEL PROYECTO -->
  <section class="project-header">
    <div class="rectangle">
      <svg class="folder" width="24" height="24" viewBox="0 0 24 24" fill="white">
        <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
      </svg>
      <h2 class="text-wrapper-2">Proyecto: <span id="titulo_proyecto">Cargando...</span></h2>
      <div class="select-field">
        <label for="week-select" style="position: absolute; width: 1px; height: 1px; overflow: hidden;">Seleccione la semana</label>
        <input type="week" id="week-select" class="select" name="week" />
      </div>
    </div>
  </section>

  <!-- TABLA DE HORAS -->
  <section class="hours-table-section">
    <div id="tabla_de_horas">
      <div style="text-align: center; padding: 40px; color: #666;">
        <div style="border: 4px solid #f3f3f3; border-top: 4px solid #8f0b09; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
        <p>Cargando tareas del proyecto...</p>
      </div>
      <style>
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      </style>
    </div>
  </section>

  <!-- BOTONES DE ACCI√ìN -->
  <div class="action-buttons">
    <button type="button" class="button-4" id="cancelBtn">
      <span>‚Üê Volver a Proyectos</span>
    </button>
    <button type="button" class="button-2" id="saveBtn" style="display: none;">
      <span>üíæ Guardar Horas</span>
    </button>
  </div>
</main>

<script>
  // ========================================
  // VARIABLES GLOBALES
  // ========================================
  const params = new URLSearchParams(window.location.search);
  const projectId = params.get('projectId');
  const resourceId = params.get('resourceId');
  const projectName = params.get('projectName');

  let tasks = [];
  let hoursData = {};

  // ========================================
  // VALIDACI√ìN INICIAL
  // ========================================
  console.log('üìã Par√°metros:', { projectId, resourceId, projectName });

  const user = getCurrentUser();

  if (!user || !resourceId || !projectId) {
    console.error('‚ùå Faltan datos necesarios');
    alert('Faltan datos necesarios para cargar las horas');
    window.location.href = 'seleccion_proyectos.html?resourceId=' + (resourceId || '');
    throw new Error('Missing required parameters');
  }

  document.getElementById('userName').textContent = user.name || 'Usuario';
  document.getElementById('titulo_proyecto').textContent = projectName || 'Proyecto';

  // Configurar semana actual - CORREGIDO ‚úÖ
  const weekInput = document.getElementById('week-select');
  weekInput.value = getCurrentWeekString();

  // ========================================
  // CARGAR TAREAS DESDE EL BACKEND
  // ========================================
  async function loadTasks() {
    const container = document.getElementById('tabla_de_horas');

    if (!container) {
      console.error("‚ùå El contenedor 'tabla_de_horas' no existe.");
      return;
    }

    try {
      console.log('üìã Cargando tareas del proyecto:', projectId);

      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #666;">
          <div style="border: 4px solid #f3f3f3; border-top: 4px solid #8f0b09; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
          <p>Cargando tareas del proyecto...</p>
        </div>
      `;

      const response = await APIClient.getTasksByProject(projectId);

      if (!response || response.length === 0) {
        console.warn('‚ö†Ô∏è No se encontraron tareas');
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <p style="font-size: 18px;">No hay tareas en este proyecto</p>
          </div>
        `;
        return;
      }

      tasks = response.filter(task => task.proyectoId === projectId);
      console.log('‚úÖ Tareas filtradas:', tasks.length);

      if (tasks.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <p style="font-size: 18px;">No hay tareas asignadas</p>
          </div>
        `;
        return;
      }

      tasks.forEach(task => {
        hoursData[task.id] = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 };
      });

      renderTable();
      document.getElementById('saveBtn').style.display = 'inline-flex';

    } catch (error) {
      console.error('‚ùå Error al cargar tareas:', error);
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #c62828;">
          <p>‚ùå Error al cargar tareas</p>
          <button class="button-2" onclick="loadTasks()">Reintentar</button>
        </div>
      `;
    }
  }

  // ========================================
  // RENDERIZAR TABLA
  // ========================================
  function renderTable() {
    const container = document.getElementById('tabla_de_horas');

    const html = `
      <div class="table-basic">
        <div class="table" role="grid">
          <div class="row" role="row">
            <div class="cell-header" role="columnheader">
              <div class="content"><span class="text-2">TAREA</span></div>
            </div>
            <div class="content-wrapper" role="columnheader">
              <div class="content"><span class="text-3">LUN</span></div>
            </div>
            <div class="content-wrapper" role="columnheader">
              <div class="content"><span class="text-2">MAR</span></div>
            </div>
            <div class="content-wrapper" role="columnheader">
              <div class="content"><span class="text-2">MI√â</span></div>
            </div>
            <div class="content-wrapper" role="columnheader">
              <div class="content"><span class="text-2">JUE</span></div>
            </div>
            <div class="content-wrapper" role="columnheader">
              <div class="content"><span class="text-2">VIE</span></div>
            </div>
            <div class="content-wrapper" role="columnheader">
              <div class="content"><span class="text-2">TOTAL</span></div>
            </div>
          </div>

          ${tasks.map(task => createTaskRow(task)).join('')}

          <div class="row-3" role="row">
            <div class="cell-default" role="rowheader">
              <span class="text-4">TOTAL POR D√çA</span>
            </div>
            <div class="cell-default-2" role="gridcell">
              <output class="text-4 total-output" id="total-mon">0.0</output>
            </div>
            <div class="cell-default-2" role="gridcell">
              <output class="text-4 total-output" id="total-tue">0.0</output>
            </div>
            <div class="cell-default-2" role="gridcell">
              <output class="text-4 total-output" id="total-wed">0.0</output>
            </div>
            <div class="cell-default-2" role="gridcell">
              <output class="text-4 total-output" id="total-thu">0.0</output>
            </div>
            <div class="cell-default-2" role="gridcell">
              <output class="text-4 total-output" id="total-fri">0.0</output>
            </div>
            <div class="cell-default-2" role="gridcell">
              <output class="text-4 total-output" id="grand-total">0.0</output>
            </div>
          </div>
        </div>
      </div>
    `;

    container.innerHTML = html;

    document.querySelectorAll('.hour-input').forEach(input => {
      input.addEventListener('input', handleHourInput);
    });
  }

  function createTaskRow(task) {
    return `
      <div class="row-2" role="row" data-task-id="${task.id}">
        <div class="cell-default" role="rowheader">
          <span class="text-4">${escapeHtml(task.nombre)}</span>
        </div>
        ${['mon', 'tue', 'wed', 'thu', 'fri'].map(day => `
          <div class="cell-default-2" role="gridcell">
            <input
              type="number"
              class="hour-input"
              data-task-id="${task.id}"
              data-day="${day}"
              min="0"
              max="24"
              step="0.5"
              value="0"
              placeholder="0"
            />
          </div>
        `).join('')}
        <div class="cell-default-2" role="gridcell">
          <output class="total-output" id="total-task-${task.id}">0.0</output>
        </div>
      </div>
    `;
  }

  function handleHourInput(e) {
    const input = e.target;
    const taskId = input.dataset.taskId;
    const day = input.dataset.day;
    let hours = parseFloat(input.value) || 0;

    if (hours < 0) hours = 0;
    if (hours > 24) hours = 24;

    input.value = hours;

    if (!hoursData[taskId]) {
      hoursData[taskId] = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 };
    }
    hoursData[taskId][day] = hours;

    updateTotals();
  }

  function updateTotals() {
    const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
    let grandTotal = 0;

    tasks.forEach(task => {
      let taskTotal = 0;
      days.forEach(day => {
        const value = hoursData[task.id]?.[day] || 0;
        taskTotal += value;
      });

      const taskTotalEl = document.getElementById(`total-task-${task.id}`);
      if (taskTotalEl) taskTotalEl.textContent = taskTotal.toFixed(1);

      grandTotal += taskTotal;
    });

    days.forEach(day => {
      let dayTotal = 0;
      tasks.forEach(task => {
        dayTotal += hoursData[task.id]?.[day] || 0;
      });

      const dayTotalEl = document.getElementById(`total-${day}`);
      if (dayTotalEl) dayTotalEl.textContent = dayTotal.toFixed(1);
    });

    const grandTotalEl = document.getElementById('grand-total');
    if (grandTotalEl) grandTotalEl.textContent = grandTotal.toFixed(1);
  }

  // ========================================
  // GUARDAR HORAS - CORREGIDO ‚úÖ
  // ========================================
  async function saveHours() {
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span>‚è≥ Guardando...</span>';

    try {
      const weekInput = document.getElementById('week-select');
      const monday = getMondayFromWeekInput(weekInput.value); // ‚úÖ FUNCI√ìN CORREGIDA

      const entriesToSave = [];
      const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
      const dayOffsets = { mon: 0, tue: 1, wed: 2, thu: 3, fri: 4 };

      tasks.forEach(task => {
        days.forEach(day => {
          const hours = hoursData[task.id]?.[day] || 0;

          if (hours > 0) {
            const workDate = new Date(monday);
            workDate.setDate(workDate.getDate() + dayOffsets[day]);

            entriesToSave.push({
              employeeId: resourceId,
              projectId: projectId,
              taskId: task.id,
              workDate: workDate.toISOString().split('T')[0],
              workedMinutes: Math.round(hours * 60),
              description: `${task.nombre} - ${formatDate(workDate)}`
            });
          }
        });
      });

      if (entriesToSave.length === 0) {
        alert('‚ö†Ô∏è No hay horas para guardar');
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<span>üíæ Guardar Horas</span>';
        return;
      }

      console.log('üíæ Guardando', entriesToSave.length, 'entradas');

      for (const entry of entriesToSave) {
        try {
          await APIClient.createTimeEntry(entry);
          console.log('‚úÖ Entrada guardada:', entry);
        } catch (error) {
          console.error('‚ùå Error:', entry, error);
          throw error;
        }
      }

      alert(`‚úÖ Se guardaron ${entriesToSave.length} registros exitosamente!`);
      resetTable();

    } catch (error) {
      console.error('‚ùå Error al guardar:', error);
      alert('‚ùå Error: ' + error.message);
    } finally {
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<span>üíæ Guardar Horas</span>';
    }
  }

  function resetTable() {
    tasks.forEach(task => {
      hoursData[task.id] = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 };
    });

    document.querySelectorAll('.hour-input').forEach(input => {
      input.value = 0;
    });

    updateTotals();
  }

  // ========================================
  // EVENT LISTENERS
  // ========================================
  document.getElementById('saveBtn').addEventListener('click', saveHours);

  document.getElementById('cancelBtn').addEventListener('click', () => {
    if (confirm('¬øVolver a proyectos? Se perder√°n los cambios.')) {
      window.location.href = `seleccion_proyectos.html?resourceId=${resourceId}`;
    }
  });

  weekInput.addEventListener('change', (e) => {
    console.log('üìÖ Semana seleccionada:', e.target.value);
  });

  // ========================================
  // UTILIDADES - CORREGIDAS ‚úÖ
  // ========================================
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function getCurrentUser() {
    try {
      const userStr = sessionStorage.getItem('user');
      return userStr ? JSON.parse(userStr) : null;
    } catch (error) {
      console.error('Error al obtener usuario:', error);
      return null;
    }
  }

  // ‚úÖ NUEVA FUNCI√ìN: Obtiene el string de la semana actual en formato "YYYY-Www"
  function getCurrentWeekString() {
    const now = new Date();
    const year = now.getFullYear();
    const weekNum = getWeekNumber(now);
    return `${year}-W${weekNum.toString().padStart(2, '0')}`;
  }

  // ‚úÖ NUEVA FUNCI√ìN: Calcula el n√∫mero de semana seg√∫n ISO 8601
  function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  // ‚úÖ NUEVA FUNCI√ìN: Convierte "2024-W47" a la fecha del lunes de esa semana
  function getMondayFromWeekInput(weekValue) {
    if (!weekValue) {
      return getMonday(new Date());
    }

    // weekValue tiene formato "2024-W47"
    const [yearStr, weekStr] = weekValue.split('-W');
    const year = parseInt(yearStr);
    const week = parseInt(weekStr);

    // Enero 4 siempre est√° en la semana 1
    const jan4 = new Date(year, 0, 4);
    const jan4Day = jan4.getDay() || 7;
    const jan4Monday = new Date(jan4);
    jan4Monday.setDate(jan4.getDate() - jan4Day + 1);

    // Sumar las semanas necesarias
    const targetMonday = new Date(jan4Monday);
    targetMonday.setDate(jan4Monday.getDate() + (week - 1) * 7);

    return targetMonday;
  }

  function getMonday(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setDate(diff));
  }

  function formatDate(date) {
    const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
    return `${days[date.getDay()]} ${date.getDate()}/${date.getMonth() + 1}`;
  }

  // ========================================
  // INICIALIZAR
  // ========================================
  loadTasks();
</script>
</body>
</html>